%signal power-20dbm noise -100dbm
%QAM 30db 0.000375 0.000375 0
%QAM 25db 0.0005 0.000125 0.000125
%QAM 20db 0.000125 0.000125 0.0005
%QAM 20db 0.00075 0.0005 0.000875
%QAM 15db 0.0005 0.0005 0.000875
%QAM 15db 0.0005 0.0005 0.000625
%QAM 10db 0.001 0.001 0.00225
%QAM 10db 0.002 0.00175 0.001875
%QAM 8db 0.077 0.001125 0.001
%QAM 8db 0.083375 0.001375 0.002625
%QAM 6db 0.061625 0.005625 0.004875
%QAM 6db 0.005125 0.0775 0.00475
%QAM 6db 0.057375 0.0675 0.003625
%QAM 6db 0.080125 0.0055 0.006375
%QAM 6db 0.004 0.003625 0.004125
%QAM 5db 0.0065 0.00675 0.00725
%QAM 5db 0.00625 0.0065 0.006625
%QAM 4db 0.08 0.00425 0.003875
%QAM 4db 0.0845 0.01225 0.0105
%QAM 4db 0.16675 0.009625 0.01
%QAM 2db 0.027 0.02775 0.026625
%QAM 2db 0.029 0.1395 0.23788
%QAM 2db 0.025875 0.02525 0.027125
%QAM 2db 0.031875 0.032375 0.52512
%QAM 1db 0.046375 0.097 0.04525
%QAM 1db 0.0475 0.04775 0.047125
%QAM 0db 0.0595 0.061375 0.05925
%QAM 0db 0.07075 0.07175 0.07125
%QAM 0db 0.13988 0.13012 0.069
%QAM 0db 0.071375 0.12762 0.12725
%QAM 0db 0.05825 0.059875 0.128
%QAM -1db 0.08175 0.082375 0.7875
%QAM -1db 0.0935 0.09325 0.0925
%QAM -2db 0.11425 0.119 0.11513
%QAM -2db 0.19137 0.10925 0.10713
%QAM -2db 0.11188 0.1135 0.11188
%QAM -2db 0.11388 0.11255 0.11038
%QAM -4db 0.16813 0.2355 0.16612
%QAM -4db 0.17188 0.17525 0.25
%QAM -4db 0.17988 0.2235 0.19575
%QAM -6db 0.26075 0.28113 0.219
%QAM -6db 0.23388 0.3245 0.24925
%QAM -6db 0.2925 0.24938 0.266
%QAM -8db 0.273 0.2745 0.276
%QAM -8db 0.29175 0.269 0.303
%QAM -8db 0.355 0.3125 0.31612
%QAM -8db 0.30162 0.30038 0.29125
%QAM -10db 0.33975 0.33037 0.36425
%QAM -10db 0.33137 0.31888 0.389
%QAM -10db 0.32075 0.354 0.31825
%QAM -15db 0.36038 0.39025 0.41225


%PSK 15db 0.000875 0.000875 0.000625
%PSK 15db 0.080625 0.000625 0.002
%PSK 15db 0.001 0.001 0.0015
%PSK 14db 0.081875 0.005125 0.005
%PSK 14db 0.002625 0.006125 0.006
%PSK 14db 0.0065 0.0065 0.0055
%PSK 12db 0.01725 0.01775 0.01425
%PSK 12db 0.01475 0.016 0.01725
%PSK 10db 0.375 0.05525 0.048
%PSK 10db 0.04225 0.23925 0.0405
%PSK 10db 0.0455 0.049 0.045
%PSK 9db 0.0705 0.135 0.1615
%PSK 9db 0.072 0.1525 0.13975
%PSK 8db 0.097125 0.16312 0.1925
%PSK 8db 0.09525 0.19775 0.11125
%PSK 8db 0.101 0.11025 0.19825
%PSK 7db 0.18175 0.211 0.24388
%PSK 7db 0.1305 0.13638 0.4035
%PSK 7db 0.1265 0.35363 0.198
%PSK 6db 0.35175 0.24013 0.2415
%PSK 6db 0.20713 0.26823 0.22462
%PSK 6db 0.152 0.37775 0.4725
%PSK 6db 0.183 0.41 0.4955
%PSK 5db 0.27287 0.26 0.265
%PSK 5db 0.28463 0.27225 0.26038
%PSK 4db 0.28987 0.29563 0.30012
%PSK 4db 0.28013 0.2925 0.28237
%PSK 3db 0.3565 0.3515 0.374
%PSK 3db 0.343 0.36225 0.28187
%PSK 2db 0.29625 0.31238 0.308
%PSK 2db 0.30512 0.3275 0.34575
%PSK 1db 0.35688 0.355 0.38338
%PSK 1db 0.34687 0.34475 0.34675
%PSK 0db 0.34175 0.34725 0.3635
%PSK 0db 0.40725 0.37962 0.40375
%PSK -1db 0.40625 0.4325 0.43075
%PSK -1db 0.39675 0.4285 0.41413
%PSK -2db 0.39337 0.38813 0.37475
%PSK -2db 0.39837 0.39887 0.37675
%PSK -3db 0.394 0.36888 0.37075
%PSK -3db 0.3645 0.37375 0.372
%PSK -4db 0.39687 0.402 0.40463
%PSK -4db 0.38575 0.3725 0.37675
%PSK -5db 0.40013 0.39837 0.40313
%PSK -5db 0.40737 0.39775 0.38938
%PSK -6db 0.40925 0.39813 0.42388
%PSK -6db 0.39187 0.38813 0.39
%PSK -8db 0.40463 0.4085 0.40413
%PSK -8db 0.40163 0.39925 0.39925
%PSK -10db 0.41775 0.42075 0.41713
%PSK -10db 0.40713 0.41113 0.41625
%PSK -15db 0.41187 0.42612 0.436
%PSK -15db 0.42188 0.429 0.44288




%ASK 9db 0 0 0
%ASK 8db 0 0 0
%ASK 6db 0.10675 0.0025 0.00325
%ASK 6db 0.002 0.002 0.002
%ASK 0db 0.0855 0.09575 0.08425
%ASK -1db 0.134 0.114 0.11175
%ASK -2db 0.147 0.2655 0.36975
%ASK -15db 0.378 0.4025 0.4035
%ASK -15db 0.39875 0.377 0.37575


%SNR=10*log10(10e-8+1)-10*log10(10e-6-10e-8);
% diff=abs(length(A1)-length(a4))+abs(length(A2)-length(a8))+abs(length(A3)-length(a3))+abs(length(A4)-length(a1))+abs(length(A5)-length(a7))+abs(length(A6)-length(a6))+abs(length(A7)-length(a5))+abs(length(A8)-length(a2));ratio=diff/8000;fprintf(['ratio is ',num2str(ratio),'\n']);
% diff_ng=abs(length(A1)-length(a1_ng))+abs(length(A2)-length(a7_ng))+abs(length(A3)-length(a6_ng))+abs(length(A4)-length(a5_ng))+abs(length(A5)-length(a2_ng))+abs(length(A6)-length(a4_ng))+abs(length(A7)-length(a8_ng))+abs(length(A8)-length(a3_ng));ratio_ng=diff_ng/8000;fprintf(['ratio of Ng is ',num2str(ratio_ng),'\n']);
% diff_my=abs(length(A1)-length(a5_my))+abs(length(A2)-length(a1_my))+abs(length(A3)-length(a3_my))+abs(length(A4)-length(a8_my))+abs(length(A5)-length(a6_my))+abs(length(A6)-length(a7_my))+abs(length(A7)-length(a4_my))+abs(length(A8)-length(a2_my));ratio_my=diff_my/8000;fprintf(['ratio of me is ',num2str(ratio_my),'\n']);
% 
snr=-15;
long=16;
close all;
% PAM_mod=comm.PAMModulator('ModulationOrder',M);
%         PAM_Demod=comm.PAMDemodulator('ModulationOrder',M);
%         s_PAM=step(PAM_mod,code).*exp(-1i*phase_offset);
%         signal=s_PAM;
%         title_str=[num2str(M),'PAM'];
PAM_mod=comm.PAMModulator('ModulationOrder',8);
        %PSK_Demod=comm.PSKDemodulator('ModulationOrder',M);
        %PSK_mod.PhaseOffset = phase_offset;
        s_PAM=step(PAM_mod,repmat((0:7)',2000/long,1));
        signal_last=s_PAM;
        fo=randn(length(signal_last),1)/50000;
        %signal_last=signal_last.*exp(1i*fo.*(1:length(signal_last))');
signal_last=awgn(signal_last,snr);
%signal_last=repmat((1:8)'+1i*(1:8)',4,1);

QAM=load('signal_8QAM.mat');
PSK=load('signal_8PSK.mat');
QAM=QAM.signal;
PSK=PSK.signal;
%QAM_mod=comm.RectangularQAMModulator('ModulationOrder',M);
%PSK_Demod=comm.RectangularQAMDemodulator('ModulationOrder',8);
PSK_Demod = comm.PSKDemodulator('ModulationOrder',8);
label_PAM=repmat((1:8)',2000/long,1);
%QAM_Demod=comm.RectangularQAMDemodulator('ModulationOrder',8);
%label_QAM= step(QAM_Demod,QAM);
%label_ASK=load('label_my.csv','-ascii');
times=10;
ratio_av=0;
ratio_ng_av=0;
ratio_my_av=0;
%for counter=1:times
%fprintf(['The ',num2str(counter),' times iteration.','\n']);
[label,center]=kmeans([real(signal_last),imag(signal_last)],8);
hold on;
h1=scatter(real(signal_last((label==1))),imag(signal_last((label==1))),'yo');
h2=scatter(real(signal_last((label==2))),imag(signal_last((label==2))),'y+');
h3=scatter(real(signal_last((label==3))),imag(signal_last((label==3))),'g*');
h4=scatter(real(signal_last((label==4))),imag(signal_last((label==4))),'g.');
h5=scatter(real(signal_last((label==5))),imag(signal_last((label==5))),'cx');
h6=scatter(real(signal_last((label==6))),imag(signal_last((label==6))),'cs');
h7=scatter(real(signal_last((label==7))),imag(signal_last((label==7))),'md');
h8=scatter(real(signal_last((label==8))),imag(signal_last((label==8))),'mp');
hold on;
axis equal;
h9=scatter((center(:,1)),(center(:,2)),'r');
text(center(1,1),center(1,2),'1');
text(center(2,1),center(2,2),'2');
text(center(3,1),center(3,2),'3');
text(center(4,1),center(4,2),'4');
text(center(5,1),center(5,2),'5');
text(center(6,1),center(6,2),'6');
text(center(7,1),center(7,2),'7');
text(center(8,1),center(8,2),'8');
legend([h1,h9],'Signals','Estimated centers');
grid on;



figure;
% QAM_mod=comm.RectangularQAMModulator('ModulationOrder',8);
%         QAM_Demod=comm.RectangularQAMDemodulator('ModulationOrder',8);
%         s_QAM=step(QAM_mod,(0:7)');
        PAM_mod=comm.PAMModulator('ModulationOrder',8);
        %PSK_mod.PhaseOffset = phase_offset;
        s_PAM=step(PAM_mod,(0:7)');
h10=scatter(real(s_PAM),imag(s_PAM),'y.');
hold on;
axis equal;
text(real(s_PAM(1)),imag(s_PAM(1)),'0');
text(real(s_PAM(2)),imag(s_PAM(2)),'1');
text(real(s_PAM(3)),imag(s_PAM(3)),'2');
text(real(s_PAM(4)),imag(s_PAM(4)),'3');
text(real(s_PAM(5)),imag(s_PAM(5)),'4');
text(real(s_PAM(6)),imag(s_PAM(6)),'5');
text(real(s_PAM(7)),imag(s_PAM(7)),'6');
text(real(s_PAM(8)),imag(s_PAM(8)),'7');



%Ratio
a1=find(label==1);
a2=find(label==2);
a3=find(label==3);
a4=find(label==4);
a5=find(label==5);
a6=find(label==6);
a7=find(label==7);
a8=find(label==8);
A1=find(label_PAM==0);
A2=find(label_PAM==1);
A3=find(label_PAM==2);
A4=find(label_PAM==3);
A5=find(label_PAM==4);
A6=find(label_PAM==5);
A7=find(label_PAM==6);
A8=find(label_PAM==7);
%%%%%%%%%%%%%%%%%%
sigma=2;
[bandwidth_last,density_last,X_last,Y_last]=kde2d([real(signal_last),imag(signal_last)]);
density_last=density_last/max(max(density_last));
w=interp2(X_last, Y_last, density_last, real(signal_last),imag(signal_last), 'spline');
weight=w*transpose(w);
[label_ng,C_ng,eigenvalue_ng]=spectral([real(signal_last),imag(signal_last)],8);
[label_my,C_my,eigenvalue_my]=myspectral([real(signal_last),imag(signal_last)],8,weight);
a1_ng=find(label_ng==1);
a2_ng=find(label_ng==2);
a3_ng=find(label_ng==3);
a4_ng=find(label_ng==4);
a5_ng=find(label_ng==5);
a6_ng=find(label_ng==6);
a7_ng=find(label_ng==7);
a8_ng=find(label_ng==8);
a1_my=find(label_my==1);
a2_my=find(label_my==2);
a3_my=find(label_my==3);
a4_my=find(label_my==4);
a5_my=find(label_my==5);
a6_my=find(label_my==6);
a7_my=find(label_my==7);
a8_my=find(label_my==8);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%BER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
order_kmeans=[5,1,2,3,7,6,8,4];
order_ng=[4,1,3,8,7,6,5,2];
order_my=[2,8,5,6,7,4,1,3];
label=(label==order_kmeans(1))+2*(label==order_kmeans(2))+3*(label==order_kmeans(3))+4*(label==order_kmeans(4))+...,
    5*(label==order_kmeans(5))+6*(label==order_kmeans(6))+7*(label==order_kmeans(7))+8*(label==order_kmeans(8));
label_ng=(label_ng==order_ng(1))+2*(label_ng==order_ng(2))+3*(label_ng==order_ng(3))+4*(label_ng==order_ng(4))+...
    5*(label_ng==order_ng(5))+6*(label_ng==order_ng(6))+7*(label_ng==order_ng(7))+8*(label_ng==order_ng(8));
label_my=(label_my==order_my(1))+2*(label_my==order_my(2))+3*(label_my==order_my(3))+4*(label_my==order_my(4))+...
    5*(label_my==order_my(5))+6*(label_my==order_my(6))+7*(label_my==order_my(7))+8*(label_my==order_my(8));
[~,ratio_kmeans]=biterr(label_PSK,label);
[~,ratio_ng]=biterr(label_PSK,label_ng);
[~,ratio_my]=biterr(label_PSK,label_my);
fprintf(['ratio is ',num2str(ratio_kmeans),'\n']);
fprintf(['ratio of Ng is ',num2str(ratio_ng),'\n']);
fprintf(['ratio of mine is ',num2str(ratio_my),'\n']);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
